{% extends "main-layout.html" %}

{% block head %}
<style>
    #transactions table {
        margin-bottom: 0;
    }
    #transactions table {
        margin-bottom: 0;
    }

    @media only screen and (max-width: 599px) {
        .collapsible.popout > li {
            margin: 0 6px;
        }
        .collapsible.popout li .collapsible-body {
            padding: 6px 10px;
        }
        .show-on-small .material-icons {
            font-size: 14px;
        }
        .show-on-small .material-icons:not(:first-child) {
            margin: 0 0 0 10px;
        }
        .badge.hide-on-med-and-up {
            min-width: 30px;
        }
        td {
            padding: 10px 5px 10px 5px;
        }
    }

    /*Option button*/
    .collapsible-header .btn-flat,
    .collapsible-header .empty {
        min-width: 0;
        width: 25px;
        height: 25px;
        margin-left: 5px;
        padding: 0;
    }
    .collapsible-header .btn-flat .material-icons,
    .collapsible-header .empty .material-icons{
        width: 1rem;
        line-height: 1;
        margin-right: 0;
    }
</style>
{% endblock %}



{% block body %}


{% macro show_transactions(transactions) %}
    {% if transactions | length > 0 %}
    <table class="bordered">
        <tbody>
            {% for t in transactions %}
            {# if t.category_id == value.category.category_id #}
            <tr>
                <td>
                    <b>{{ t.description }}</b>
                    <span class="hide-on-med-and-up show-on-small">
                        <i class="material-icons">attach_money</i> {{ t.amount }}
                        <i class="material-icons">date_range</i> {{ t.date.strftime("%d-%b-%Y") }}
                        <i class="material-icons">account_balance</i> {{ t.bank.name }}
                    </span>
                </td>
                <td class="amount hide-on-small-only">{{ t.amount }}</td>
                <td class="hide-on-small-only">{{ t.date.strftime("%d-%b-%Y") }}</td>
                <td class="hide-on-small-only">{{ t.bank.name }}</td>
            </tr>
            {# endif #}
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
{% endmacro %}


{% macro create_categories_panels(cat_dict) %}
    {% for key, value in cat_dict recursive %}
        {% if value.category.parent_id is none %}
        <div id="{{ value.category.category_id }}" class="section scrollspy">
            <div class="row">
                <div class="col s12 m3">
                    <h5 class="light">
                        {% if value.category.icon %}<i class="fa {{ value.category.icon }}" aria-hidden="true"></i>{% endif %}
                        <span name="name">{{ value.category.name }}</span>
                    </h5>
                    <blockquote>{{ value.count }} transactions</blockquote>
                </div>

                <div class="col s12 m9">
                    {% if value.count == 0 %}
                    <h2>Pas de transactions dans cette catégorie.</h2>
                    {% else %}
                    <ul class="collapsible popout" data-collapsible="accordion">
                        {% if value.children | length > 0 %}
                        {{ loop(value.children.items()) }}
                        {% endif %}

                        {% if value.transactions | length > 0 %}
                        <li class="cat">
                            <div class="collapsible-header">
                                <i class="material-icons">more_horiz</i>
                                <span name="name">Autres</span>
                                <span class="badge empty"><i class="material-icons"></i></span>
                                <span class="badge hide-on-med-and-up">{{ value.transactions | length }}</span>
                                <span class="badge hide-on-small-only" data-badge-caption="transactions">{{ value.transactions | length }}</span>
                            </div>
                            <div class="collapsible-body" style="display: block;">
                                {{ show_transactions(value.transactions) }}
                            </div>
                        </li>
                        {% endif %}
                    </ul>
                    {% endif %}
                </div>
            </div>
        </div>

        {% else %}

        <li class="cat" id="{{ value.category.category_id }}">
            <div class="collapsible-header">
                {% if value.category.icon %}<i class="fa {{ value.category.icon }}" aria-hidden="true"></i>{% endif %}
                <span name="name">{{ value.category.name }}</span>

                <span class="badge btn-flat waves-effect options tooltipped" data-position="right" data-delay="50" data-tooltip="Options">
                    <i class="material-icons">more_vert</i>
                </span>

                <span class="badge hide-on-med-and-up">{{ value.count }}</span>
                <span class="badge hide-on-small-only" data-badge-caption="transactions">{{ value.count }}</span>

                <span name="dollar-bill"></span>

                {% if value.limit %}
                <div class="progress">
                    <div name="limit" data-limit="{{ value.limit.value }}" class="determinate" style="width: 0%"></div>
                </div>
                {% endif %}
            </div>
            <div class="collapsible-body" style="display: block;">

                {{ show_transactions(value.transactions) }}

                {% if value.children | length > 0 %}
                <div class="">
                    <ul class="collapsible" data-collapsible="expandable">
                        {{ loop(value.children.items()) }}
                    </ul>
                </div>
                {% endif %}
            </div>
        </li>
        {% endif %}
    {% else %}
    <div class="section">
        <h5>Vous n'avez actuellement aucune transaction.</h5>
        <p>Cliquez sur le bouton '+' pour ajouter votre premier!</p>
    </div>
    {% endfor %}
{% endmacro %}

<div id="transactions" class="row">
    {{ create_categories_panels(transactions_tree.items()) }}
</div>
<div class="fixed-action-btn" style="bottom: 45px; right: 24px;">
    <a class="btn-floating btn-large waves-effect waves-light red tooltipped" data-position="left" data-delay="50" data-tooltip="Ajouter une transaction" onclick="addTransaction(1)">
    <i class="material-icons">add</i>
    </a>
</div>

{% import "macros/modals.html" as modals %}
{{ modals.category_options() }}
{{ modals.add_transaction(banks, categories, today) }}

{% endblock %}

{% block js %}
<script type="text/javascript">
    {% import "macros/modals.html" as modals %}
    {{ modals.add_transaction_js() }}

    // Expand all sub-cat
    var subCat = $(".cat li .collapsible-body li .collapsible-header");
    subCat.addClass('active');
    subCat.parent().addClass('active');

    /* Get total amount of money for all category */
    $(".cat").each(function() {
        var total = 0.0,
            parent = $(".collapsible-header", this);
        $(".amount", this).each(function() {
            total += parseFloat(this.textContent)
        });
        var limit = $("[name='limit']", parent).data('limit'),
            percent = Math.round((total/parseFloat(limit))*100),
            progressBar = $("[name='limit']", parent),
            tooltip = "";

        if (progressBar.length != 0) {

            if (percent < 100) {
                tooltip = 'tooltipped" data-tooltip="'+(limit-total).toFixed(2)+'$ restant ('+percent+'% utilisé)" data-position="left" data-delay="50';
                progressBar.css('width', percent+'%');
            } else {
                tooltip = 'tooltipped" data-tooltip="'+(total-limit).toFixed(2)+'$ de dépassé! ('+percent+'%)" data-position="left" data-delay="50';
                progressBar.css('width', '100%').addClass('red darken-4');
            }
        }

        $("[name='dollar-bill']", parent).html('<span class="new badge '+tooltip+'" data-badge-caption="$">'+total.toFixed(2)+'</span>');
    });

    /* Function to open a category options modal */
    $(".collapsible-header .options").click(function(e) {
        e.stopPropagation();
        var form = $("#category-options-form");
        form.trigger('reset');
        var category = $(event.target).closest(".collapsible-header");

        // Setting title
        $("#category-icon", form).attr("class", $("i.fa", category).attr("class"));
        $("#category-title", form).html($("[name='name']", category).html());
        $("[name='cat']", form).val(category.parent().attr('id'));

        // Setting limit
        var limit = $("[name='limit']", category);
        $("[name='limit']", form).val(limit.length != 0 ? limit.data('limit') : "")
            .prop('disabled', limit.length == 0);
        Materialize.updateTextFields();
        $("[name='setLimit']").prop('checked', limit.length != 0);

        $("#category-options").modal('open');
    });

    /* Saving category options changes */
    $("#category-options-form").submit(function (event) {
        event.preventDefault();
        var url = "{{ url_for('budgeto_services.save_category_options') }}",
            data = $(this).serialize(),
            errorMessage = "Erreur lors de l'enregistrement des options. Merci d'essayer plus tard.";

        endless.post(url, data, errorMessage).done(function() {
            $("#category-options-modal").modal('close');
            location.reload();
        });
    });
</script>
{% endblock %}