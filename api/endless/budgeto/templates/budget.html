{% extends "main-layout.html" %}

{% block head %}
<style>
    #transactions table {
        margin-bottom: 0;
    }
    #transactions table {
        margin-bottom: 0;
    }

</style>
{% endblock %}



{% block body %}


{% macro show_transactions(transactions) %}
    {% if transactions | length > 0 %}
    <table class="bordered">
        <tbody>
            {% for t in transactions %}
            {# if t.category_id == value.category.category_id #}
            <tr>
                <td><b>{{ t.description }}</b></td>
                <td class="amount">{{ t.amount }}</td>
                <td>{{ t.date }}</td>
                <td>{{ t.bank.name }}</td>
            </tr>
            {# endif #}
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
{% endmacro %}


{% macro create_categories_panels(cat_dict) %}
    {% for key, value in cat_dict recursive %}
        {% if value.category.parent_id is none %}
        <div id="{{ value.category.category_id }}" class="section scrollspy">
            <div class="row">
                <div class="col s12 m3">
                    <h5 class="light">
                        {% if value.category.icon %}<i class="fa {{ value.category.icon }}" aria-hidden="true"></i>{% endif %}
                        <span name="name">{{ value.category.name }}</span>
                    </h5>
                    <blockquote>{{ value.count }} transactions</blockquote>
                </div>

                <div class="col s12 m9">
                    {% if value.count == 0 %}
                    <h2>No transactions in this category yet</h2>
                    {% else %}
                    <ul class="collapsible popout" data-collapsible="accordion">
                        {% if value.children | length > 0 %}
                        {{ loop(value.children.items()) }}
                        {% endif %}

                        {% if value.transactions | length > 0 %}
                        <li class="cat">
                            <div class="collapsible-header">
                                <i class="material-icons">more_horiz</i>
                                <span name="name">Autres</span>
                                <span class="badge" data-badge-caption="transactions">{{ value.transactions | length }}</span>
                            </div>
                            <div class="collapsible-body" style="display: block;">
                                {{ show_transactions(value.transactions) }}
                            </div>
                        </li>
                        {% endif %}
                    </ul>
                    {% endif %}
                </div>
            </div>
        </div>

        {% else %}

        <li class="cat" id="{{ value.category.category_id }}">
            <div class="collapsible-header">
                {% if value.category.icon %}<i class="fa {{ value.category.icon }}" aria-hidden="true"></i>{% endif %}
                <span name="name">{{ value.category.name }}</span>
                <span class="badge" data-badge-caption="transactions">{{ value.count }}</span>
            </div>
            <div class="collapsible-body" style="display: block;">
                {{ show_transactions(value.transactions) }}

                {% if value.children | length > 0 %}
                <div class="">
                    <ul class="collapsible" data-collapsible="expandable">
                        {{ loop(value.children.items()) }}
                    </ul>
                </div>
                {% endif %}
            </div>
        </li>
        {% endif %}
    {% endfor %}
{% endmacro %}

<div id="transactions" class="row">
    {{ create_categories_panels(transactions_tree.items()) }}
</div>


{% endblock %}

{% block js %}
<script type="text/javascript">
    // Expand all sub-cat
    var subCat = $(".cat li .collapsible-body li .collapsible-header");
    subCat.addClass('active');
    subCat.parent().addClass('active');

    // Get total amount for all cat
    $(".cat").each(function() {
        var total = 0.0;
        $(".amount", this).each(function() {
            total += parseFloat(this.textContent)
        });
        $(".collapsible-header:first", this).append('<span class="new badge" data-badge-caption="$">'+total.toFixed(2)+'</span>');
    });
</script>
{% endblock %}