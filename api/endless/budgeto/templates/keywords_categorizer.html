{% extends "main-layout.html" %}

{% block head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.css" rel="stylesheet">
<style>
    .keyword {
        margin-right: 4px;
        font-size: 1em;
        line-height: 2;
        cursor: grab;
        cursor: -moz-grab;
        cursor: -webkit-grab;
        -webkit-touch-callout: none; /* iOS Safari */
        -webkit-user-select: none; /* Chrome/Safari/Opera */
        -khtml-user-select: none; /* Konqueror */
        -moz-user-select: none; /* Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
        user-select: none; /* Non-prefixed version, currently
                              not supported by any browser */
    }
    .child-icon {
        color: #999999;
        text-shadow: 1px 1px 1px #ccc;
        font-size: 0.9em;
    }
</style>
{% endblock %}

{% block body %}

{% macro create_keyword_div(keyword) %}
<div data-id="{{ keyword.keyword_id }}" class="label label-default keyword">
    {{ keyword.value or ('&nbsp;' | safe) }}
</div>
{% endmacro %}

{% macro create_categories_panels(cat_dict) %}
{% for key, value in cat_dict recursive %}
<div class="{% if value.category.parent_id is none %}parent-panel col-lg-3{% endif %}">
    <div class="panel panel-default">
        <div class="panel-heading">
            <a data-toggle="collapse" href="#{{ value.category.category_id }}">
                {% if value.category.icon %}<i class="fa {{ value.category.icon }}" aria-hidden="true"></i>{% endif %}
                <span name="name">{{ value.category.name }}</span>
                (<span data-type="keywords-number">{{ keywords[value.category.category_id] | length }}</span>)
            </a>
            {% if value.children | length > 0 %}
            :
            {% for child_key, child_value in value.children.items() %}
            {% if child_value.category.icon %}<i class="child-icon fa {{ child_value.category.icon }}" aria-hidden="true"></i>{% endif %}
            {% endfor %}
            {% endif %}
        </div>
        <div id="{{ value.category.category_id }}" class="panel-collapse collapse {% if value.category.parent_id is none %}in{% endif %}">
            <div class="panel-body draggable-container" data-id="{{ value.category.category_id }}">
                {% for k in keywords[value.category.category_id] %}
                {{ create_keyword_div(k) }}
                {% endfor %}
            </div>
            {% if value.children | length > 0 %}
            <div class="panel-footer">
                {{ loop(value.children.items()) }}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endfor %}
{% endmacro %}


<br>

<div class="row">
    <div class="col-lg-3">
        <div class="panel panel-primary">
            <div class="panel-heading">
                <i class="fa fa-align-justify" aria-hidden="true"></i> Keywords
                (<span data-type="keywords-number">{{ keywords[-1] | length }}</span>)
            </div>
            <div class="panel-body draggable-container" data-id="-1">
                {% for k in keywords[-1] %}
                {{ create_keyword_div(k) }}
                {% endfor %}
            </div>
        </div>
    </div>

    {{ create_categories_panels(categories.items()) }}
</div>

{% endblock %}

{% block js %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js" type="text/javascript"></script>

<script type="text/javascript">
    drake = dragula(Array.prototype.slice.call(document.querySelectorAll('.draggable-container')));

    var draggingObject = undefined;
    drake.on('drop',function(el, target, source) {
       if (target != source) {
           var old_category_counter = $("[data-type='keywords-number']:first", $(source).parent().parent());
           var category_counter = $("[data-type='keywords-number']:first", $(target).parent().parent());
           old_category_counter.html(parseInt(old_category_counter.html())-1);
           category_counter.html(parseInt(category_counter.html())+1);
           $.ajax({
               url: "{{ url_for('budgeto_services.link_keyword_to_category') }}",
               type: 'post',
               data: { categoryId: $(target).data('id'),
                       keywordId: $(el).data('id')
               }
           }).done(function() {
              //do something else
           });
       }
    });

    drake.on('drag',function(el) {
        draggingObject = $(el);
        draggingObject.css('pointer-events', 'none')
    });

    drake.on('dragend',function(el) {
        draggingObject.css('pointer-events', '')
        draggingObject = undefined;
    });

    $(".panel-heading").mouseenter(function () {
        if (draggingObject != undefined) {
            var collapseId = $("a[data-toggle='collapse']", this).attr('href');
            $(collapseId).collapse('show');
        }
    });
    $(".panel").mouseleave(function () {
        if (draggingObject != undefined) {
            var collapse = $($("a[data-toggle='collapse']", this).attr('href'));
            if (!collapse.closest('.panel').parent().hasClass('parent-panel')) {
                collapse.collapse('hide');
            }
        }
    });
</script>

{% endblock %}


