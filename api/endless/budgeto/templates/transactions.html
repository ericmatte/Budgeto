{% extends "main-layout.html" %}

{% block head %}
<style type='text/css'>
    .card .card-image .card-title {
        padding: 12px;
        padding-left: 24px;
    }
    .card .card-content {
        padding: 0;
    }
    table tr td:first-child, table tr th:first-child {
        padding-left: 15px;
    }
    table tr td:last-child, table tr th:last-child {
        padding-right: 0;
    }
</style>
{% endblock %}


{% block options %}
<li><a onclick="addTransaction(1)">Add a transaction</a></li>
{% endblock %}


{% block body %}


{% macro show_transactions(transactions) %}
<table class="striped">
    <thead><tr>
        <th><span class="hide-on-small-only">Category</span></th>
        <th>Description</th>
        <th>Amount</th>
        <th>Date</th>
    </tr></thead>
    <tbody>
        {% for t in transactions | sort(attribute='upload_time', reverse=True) %}
        <tr>
            <td>
                <i class="fa {{ t.category.icon }}" aria-hidden="true"></i>
                <span class="hide-on-small-only">{{ t.category.name }}</span>
            </td>
            <td>{{ t.description }}</td>
            <td>{{ t.amount }}</td>
            <td>{{ t.date }}</td>
            <td><a href="#" onclick="deleteTransaction({{ t.transaction_id }})">x</a></td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endmacro %}


{% set b = {'has_transactions': False} %}
{% for bank in banks %}
    {% if bank.transactions | length > 0 %}
    {% if b.update({'has_transactions': True}) %}{% endif %}
    <div class="section">
        <div class="row">
            <div class="col s12 m12">
                <div class="card">
                    <div class="card-image" style="background-color: #{{ bank.color }}">
                        <span class="card-title black-text">{{ bank.name }}</span>
                        <img src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" height="60px" style="padding: 10px">
                        <a class="btn-floating halfway-fab waves-effect waves-light red tooltipped"
                           onclick="addTransaction({{ bank.bank_id }})" data-tooltip="Add a transaction" data-position="left" data-delay="50">
                            <i class="material-icons">add</i>
                        </a>
                    </div>
                    <div class="card-content">
                        {{ show_transactions(bank.transactions) }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
{% endfor %}

{% if not b.has_transactions %}
<div class="section">
    <h5>You currently have no transactions.</h5>
</div>
{% endif %}

{% import "macros/modals.html" as modals %}
{{ modals.add_transaction(banks, categories, today) }}
{{ modals.warning_message() }}
{% endblock %}




{% block js %}
<script type="text/javascript">
    function addTransaction(bankId) {
        var form = $("#new-transaction-form");
        form.trigger('reset');
        $("[name='bank']", form).val(bankId).change().material_select();
        $("#new-transaction-modal").modal('open');
    }

    $("#new-transaction-form").submit(function (event) {
        event.preventDefault();
        $.ajax({
            type: "POST",
            url: "{{ url_for('budgeto_services.add_transaction') }}",
            data: $(this).serialize(),
            success: function () {
                $("#new-transaction-modal").modal('close');
                location.reload();
            },
            error: function(e) {
                Materialize.toast('Error while adding the transaction. Please try later.', 4000);
            },
            complete: function () {
            }
        });
    });

    function deleteTransaction(transactionId) {
        var modal = $("#warning-modal");
        $("[name='id']", modal).val(transactionId);
        modal.modal('open');
    }

    $("#warning-form").submit(function (event) {
        event.preventDefault();
        $.ajax({
            type: "POST",
            url: "{{ url_for('budgeto_services.delete_transaction') }}",
            data: $(this).serialize(),
            success: function () {
                $("#new-transaction-modal").modal('close');
                location.reload();
            },
            error: function(e) {
                Materialize.toast('Error while removing the transaction. Please try later.', 4000);
            },
            complete: function () {
            }
        });
    });
</script>
{% endblock %}