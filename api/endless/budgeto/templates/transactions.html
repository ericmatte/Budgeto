{% extends "main-layout.html" %}

{% block head %}
<style type='text/css'>
    .card .card-image .card-title {
        padding: 12px;
        padding-left: 24px;
    }
    .card .card-content {
        padding: 0;
    }
    table tr td:first-child, table tr th:first-child {
        padding-left: 15px;
    }
    table tr td:last-child, table tr th:last-child {
        padding-right: 0;
    }
</style>
{% endblock %}


{% block options %}
<li><a onclick="addTransaction(1)">Ajouter une transaction</a></li>
{% endblock %}


{% block body %}


{% macro show_transactions(transactions) %}
<table class="striped">
    <thead><tr>
        <th><span class="hide-on-small-only">Cat√©gorie</span></th>
        <th>Description</th>
        <th>Montant</th>
        <th>Date</th>
    </tr></thead>
    <tbody>
        {% for t in transactions | sort(attribute='upload_time', reverse=True) %}
        <tr>
            <td>
                <i class="fa {{ t.category.icon }}" aria-hidden="true"></i>
                <span class="hide-on-small-only">{{ t.category.name }}</span>
            </td>
            <td>{{ t.description }}</td>
            <td>{{ t.amount }}</td>
            <td>{{ t.date.strftime("%d-%b-%Y") }}</td>
            <td><a href="#" onclick="deleteTransaction({{ t.transaction_id }})">x</a></td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endmacro %}


{% set b = {'has_transactions': False} %}
{% for bank in banks %}
    {% if bank.transactions | length > 0 %}
    {% if b.update({'has_transactions': True}) %}{% endif %}
    <div class="section">
        <div class="row">
            <div class="col s12 m12">
                <div class="card">
                    <div class="card-image" style="background-color: #{{ bank.color }}">
                        <span class="card-title black-text">{{ bank.name }}</span>
                        <img src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" height="60px" style="padding: 10px">
                        <a class="btn-floating halfway-fab waves-effect waves-light red tooltipped"
                           onclick="addTransaction({{ bank.bank_id }})" data-tooltip="Add a transaction" data-position="left" data-delay="50">
                            <i class="material-icons">add</i>
                        </a>
                    </div>
                    <div class="card-content">
                        {{ show_transactions(bank.transactions) }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
{% endfor %}

{% if not b.has_transactions %}
<div class="section">
    <h5>Vous n'avez actuellement aucune transaction.</h5>
    <p>Cliquez sur le bouton '+' pour ajouter votre premier!</p>
</div>

<div class="fixed-action-btn" style="bottom: 45px; right: 24px;">
    <a class="btn-floating btn-large waves-effect waves-light red tooltipped" data-position="left" data-delay="50" data-tooltip="Ajouter une transaction" onclick="addTransaction(1)">
    <i class="material-icons">add</i>
    </a>
</div>
{% endif %}

{% import "macros/modals.html" as modals %}
{{ modals.add_transaction(banks, categories, today) }}
{{ modals.warning_message() }}
{% endblock %}




{% block js %}
<script type="text/javascript">
    {% import "macros/modals.html" as modals %}
    {{ modals.add_transaction_js() }}

    function deleteTransaction(transactionId) {
        var modal = $("#warning-modal");
        $("[name='id']", modal).val(transactionId);
        modal.modal('open');
    }

    $("#warning-form").submit(function (event) {
        event.preventDefault();
        var url = "{{ url_for('budgeto_services.delete_transaction') }}",
            data = $(this).serialize(),
            errorMessage = "Erreur lors de la suppression de la transaction. Merci d'essayer plus tard.";

        endless.post(url, data, errorMessage).done(function() {
            $("#warning-form").modal('close');
            location.reload();
        });
    });
</script>
{% endblock %}